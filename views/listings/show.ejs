<% layout('/layouts/boilerplate') %>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="text-center mb-4">
                <h2 class="fw-bold" style="color: #222222;"><%= listing.title %></h2>
            </div>

            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="position-relative">
                    <img src="<%= listing.image.url %>" class="card-img-top" style="height: 280px; object-fit: cover;" alt="<%= listing.title %>">
                </div>
                <div class="card-body p-4">
                    <i class="fas fa-user me-2"></i>
                    <span class="text-muted">Owned by <%= listing.owner ? listing.owner.username : 'Unknown' %></span>
                    <p class="text-muted mb-4 lh-base"><%= listing.description %></p>
                    
                    <h4 class="fw-bold mb-3" style="color: #2563EB;">â‚¹<%= listing.price.toLocaleString("en-IN") %></h4>
                    
                    <div class="d-flex align-items-center mb-4 text-muted">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        <span><%= listing.location %></span>
                    </div>
                    
                    <div class="d-flex align-items-center mb-4 text-muted">
                        <i class="fas fa-globe me-2"></i>
                        <span><%= listing.country %></span>
                    </div>
                    <div class="d-flex gap-3">
                        <% if(currentUser && listing.owner && listing.owner.equals(currentUser._id)) { %>
                        <a href="/listings/<%= listing._id %>/edit" class="btn btn-danger btn-lg px-4" style="background-color: #dc3545; border-color: #dc3545;">
                            Edit
                        </a>
                        
                        <button type="button" class="btn btn-dark btn-lg px-4" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            Delete
                        </button>
                        <% } %>
                    </div>

                    
                    <div class="mt-4">
                        <% if(currentUser) { %>
                        <h4 class="fw-bold">Leave a Review</h4>
                        <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
                            <div class="mb-3">
                                <label for="rating-value" class="form-label">Rating</label>
                                <div class="star-rating">
                                    <i class="far fa-star star" data-rating="1"></i>
                                    <i class="far fa-star star" data-rating="2"></i>
                                    <i class="far fa-star star" data-rating="3"></i>
                                    <i class="far fa-star star" data-rating="4"></i>
                                    <i class="far fa-star star" data-rating="5"></i>
                                </div>
                                <input type="hidden" id="rating-value" name="review[Rating]" value="" required>
                                <div class="invalid-feedback">
                                    Please provide a rating by clicking on the stars.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="Comment" class="form-label">Comment</label>
                                <textarea id="Comment" name="review[Comment]" class="form-control" rows="3" placeholder="Write your review here..." required></textarea>
                                <div class="invalid-feedback">
                                    Please provide a comment for your review.
                                </div>
                            </div>
                            <div class="mb-3">
                                <button type="submit" class="btn btn-outline-dark">Submit Review</button>
                            </div>
                        </form>
                        <% } else { %>
                            <p class="text-muted">You must be logged in to leave a review.</p>
                        <% } %>
                        <hr>

                        <p><b>All Reviews</b></p>
                        <% if (listing.reviews && listing.reviews.length > 0) { %>
                            <div class="row">
                                <% for (let review of listing.reviews) { %>
                                    <div class="col-6 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                    <i class="fas fa-user me-2"></i>
                                    <%= review.author ? review.author.username : 'Anonymous' %>
                                </h5>
                                                <p class="card-text"><%= review.Comment %></p>
                                                <p class="card-text">
                                                    <% for (let i = 0; i < review.Rating; i++) { %>
                                                        <i class="fas fa-star" style="color: #333;"></i>
                                                    <% } %>
                                                    <% for (let i = review.Rating; i < 5; i++) { %>
                                                        <i class="far fa-star" style="color: #ddd;"></i>
                                                    <% } %>
                                                    <span class="ms-2 text-muted">(<%= review.Rating %>/5)</span>
                                                </p>
                                                <% if(currentUser && review.author && review.author._id.equals(currentUser._id)) { %>
                                                <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-dark">Delete</button>
                                                </form>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        <% } else { %>
                            <p class="text-muted">No reviews yet. Be the first to leave a review!</p>
                        <% } %>
                        
                    </div>
                </div>
            </div>

            <!-- Location Map Section -->
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden mt-4">
                <div class="card-body p-4">
                    <h4 class="fw-bold mb-3" style="color: #2563EB;">
                        <i class="fas fa-map-marker-alt me-2"></i>Location
                    </h4>
                    <p class="text-muted mb-3">
                        <i class="fas fa-map-pin me-2"></i><%= listing.location %>, <%= listing.country %>
                    </p>
                    <div id="map" style="height: 300px; border-radius: 8px; border: 1px solid #e0e0e0;"></div>
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="/listings" class="text-decoration-none" style="color: #2563EB;">
                    <i class="fas fa-arrow-left me-2"></i>Back to All Listings
                </a>
            </div>

        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<% if(currentUser && listing.owner && listing.owner.equals(currentUser._id)) { %>
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this listing? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
<% } %>

<!-- Leaflet CSS and JS for Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>

<script>
    // Initialize the map
    document.addEventListener('DOMContentLoaded', function() {
        // Get location string and try to geocode it
        const locationString = '<%= listing.location %>, <%= listing.country %>';
        
        // Create map centered on a default location (you can adjust this)
        const map = L.map('map').setView([20.5937, 78.9629], 5); // Default to India center
        
        // Add OpenStreetMap tiles (free)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);
        
        // Try to geocode the location using Nominatim (free geocoding service)
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationString)}&limit=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    
                    // Center map on the found location
                    map.setView([lat, lon], 13);
                    
                    // Add marker
                    L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(`
                            <div style="text-align: center;">
                                <strong><%= listing.title %></strong><br>
                                <i class="fas fa-map-marker-alt"></i> ${locationString}<br>
                                <small class="text-muted">â‚¹<%= listing.price.toLocaleString("en-IN") %> per night</small>
                            </div>
                        `)
                        .openPopup();
                } else {
                    // If geocoding fails, show a message
                    document.getElementById('map').innerHTML = `
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <div class="text-center">
                                <i class="fas fa-map-marker-alt fa-3x mb-3" style="color: #dc3545;"></i>
                                <p class="mb-0">Unable to display map for this location</p>
                                <small>${locationString}</small>
                            </div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error geocoding location:', error);
                // Show fallback message
                document.getElementById('map').innerHTML = `
                    <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                        <div class="text-center">
                            <i class="fas fa-map-marker-alt fa-3x mb-3" style="color: #dc3545;"></i>
                            <p class="mb-0">Map temporarily unavailable</p>
                            <small>${locationString}</small>
                        </div>
                    </div>
                `;
            });
    });
</script>



